# WireGuard 邀请码动态注册系统开发方案 (Draft v1.0)

## 1. 核心目标 (Objective)
废除传统的 `/etc/wireguard/*.conf` 静态文件分发模式，通过自定义的 `wireguard-go` 二开版本，实现**“邀请码驱动”**的云端配置分发与内存直接注入，提升系统安全性与运维灵活性。

## 2. 系统架构 (Architecture)
*   **模式**：星型拓扑 (Star Topology)。
*   **中心节点 (母舰)**：具备公网 IP 的 Debian 服务器，运行带 WebUI 的 `wireguard-go`。
*   **边缘节点 (客户端)**：无配置文件启动，通过 API 获取配置并注入内存。

## 3. 已完成基础 (Completed)
*   [x] **后端 UAPI 对接**：实现通过 Unix Socket 与网卡核心对话。
*   [x] **WebUI 认证系统**：增加了基于 `WEBUI_PASSWORD` 的 Session 登录保护。
*   [x] **核心代码插桩**：验证了通过 UAPI 实时修改网卡状态的可行性。

## 4. 正在设计的核心模块 (Modules)

### A. 持久化方案 (Persistence) - **[确立：JSON 文件存储]**
*   **文件路径**：`data/config.json` (默认权限 0600)。
*   **存储内容**：服务端私钥、监听端口、分发用的 Endpoint 域名/IP、所有已激活 Peer 的详情、有效期内的邀请码。
*   **同步策略**：启动时全量加载到内存；运行时发生 Peer 增删或邀请码生成，立即执行 Atomic Write (先写临时文件再重命名) 以防数据损坏。

### B. 客户端发现与 Endpoint 策略 (Endpoint Strategy) - **[确立：A + C 模式]**
*   **策略 A (手动/持久化)**：在 JSON 配置文件中手动指定 `public_endpoint`。
*   **策略 C (动态覆盖)**：通过命令行参数 `--endpoint xxx.xxx.xxx.xxx` 在启动时强制覆盖 JSON 中的设置。
*   **分发逻辑**：服务端在响应注册请求时，直接从上述生效的 Endpoint 中读取值并下发给客户端。

### C. 邀请码管理 (Invite Manager)
*   **功能**：生成随机 Token，绑定预设备注（如“某某的手机”）。
*   **过期与复用**：确立包含过期时间；确立“一码一用”（One-time use）策略。
*   **失效时机 (Invalidation)**：确立“方案 B” —— 邀请码仅在注册行为（`IpcSet`）成功完成后失效，单纯访问引导页不消耗次数。
*   **注册体验 (Registration)**：确立“双轨制”引导页。
### D. 客户端自助入驻界面 (Client UI)
*   **角色适配**：客户端启动后同样开启本地 8080 端口，但展示“个人中心”界面。
*   **核心表单**：针对小白用户，仅需填写两个字段：
    1.  **母舰地址** (Server Address): 支持 IP 或域名，后端自动处理协议头与端口。
    2.  **邀请码** (Invite Code): 管理员生成的单次有效 Token。
*   **极简入网**：点击“一键入网”，客户端代为生成私钥、完成注册并注入内存。
*   **状态监控**：直观展示当前节点的内网 IP、连接延时及实时流量图表。

## 5. 关键讨论疑点 (Open Questions)
*   [x] **持久化方案**：确立 JSON 文件存储 (`data/config.json`)。
*   [x] **Endpoint 策略**：确立 A+C 模式（手动预设 + 参数覆盖）。
*   [x] **复用策略**：确立一码一用 (One-time use)。
*   [x] **失效时机**：确立注册完成后失效 (On-success)。
*   [x] **分发体验**：确立“本地 WebUI + Token”模式，支持扫码与指令。

---
*最后更新时间：2026-02-17*
