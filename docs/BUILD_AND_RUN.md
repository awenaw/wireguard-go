# WireGuard-Go 编译与构建说明

> 本文档详细说明了如何编译、构建和运行 `wireguard-go` 程序，涵盖多平台交叉编译指南。

---

## 1. 程序简介

`wireguard-go` 是 WireGuard 协议的用户态（Userspace）Go 语言实现。
与内核模块（Kernel Module）不同，它运行在用户空间，通过 TUN 设备处理网络包，具有极佳的移植性和安全性。

**主要用途：**
*   **macOS / Windows**: 这是官方推荐的标准实现（因为这两个系统没有原生 Linux 内核模块）。
*   **Android**: Android 版 WireGuard App 的底层核心就是它。
*   **嵌入式 Linux**: 对于无法升级内核的老旧嵌入式设备，这是唯一的出路。

---

## 2. 编译指南 (Build Guide)

### 前置要求
*   Go 1.16+ (推荐 1.20+)
*   Make (可选，用于快捷命令)

### 2.1 本地编译 (macOS/Linux)

最简单的编译方式，直接生成当前架构的可执行文件：

```bash
# 下载依赖
go mod download

# 编译
go build -o wireguard-go
# 或者使用 Makefile
make
```

### 2.2 调试版本编译

如果需要配合 Delve 调试或查看未优化的堆栈信息：

```bash
# 关闭编译器优化 (-N) 和内联 (-l)
go build -gcflags="all=-N -l" -o wireguard-go-debug
```

### 2.3 交叉编译 (Cross Compilation)

这是为您的 IoT 设备（Windows 拍照机、ARM 网关等）生成程序的关键步骤。

#### 📦 为 Windows (x64) 编译
```bash
# 生成 .exe 文件
CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -o wireguard-go.exe
```

#### 📦 为 ARM64 Linux (如树莓派/嵌入式网关) 编译
```bash
CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -o wireguard-go-arm64
```

#### 📦 为 macOS (Universal/Apple Silicon) 编译
```bash
GOOS=darwin GOARCH=arm64 go build -o wireguard-go-mac-arm64
```

---

## 3. 运行参数 (Usage)

`wireguard-go` 本身只负责创建一个虚拟网卡接口。它**不负责**读取配置文件（那是 `wg-quick` 或 `wg` 某些工具的事）。它更像是一个守护进程。

**基本语法：**
```bash
wireguard-go [参数] <接口名称>
```

**常用参数：**
*   `-f`, `--foreground`: 前台运行（不作为 Daemon 守护进程）。**调试时必加**。
*   `-v`, `--verbose`: 开启详细日志（打印 info/debug 级别日志到 stderr）。

**示例：**

```bash
# 在前台启动一个名为 utun9 的接口，并打印详细日志
sudo ./wireguard-go -f -v utun9
```

---

## 4. 如何配置它？ (Control)

`wireguard-go` 启动后，只是一个“空壳”。你需要通过 UAPI (Unix Socket / Windows Named Pipe) 告诉它私钥是什么、要连谁。

通常配合 `wireguard-tools` 工具包使用：

```bash
# 1. 启动程序
sudo ./wireguard-go utun9

# 2. 配置地址 (OS 层)
sudo ifconfig utun9 10.0.0.1 10.0.0.1 up

# 3. 配置 WireGuard 参数 (App 层)
# 这一步 wg 工具会通过 Socket 用 UAPI 协议跟 wireguard-go 对话
sudo wg setconf utun9 my-config.conf
```

对于 Windows，这一切通常被封装在我们的 Agent 程序里自动完成。

---

## 5. 项目结构与产物

*   **`main.go`**: 程序的入口，处理命令行参数，监听信号量。
*   **`tun/`**: 及其重要的目录，包含了适配不同操作系统的 TUN 设备驱动逻辑。
    *   `tun_windows.go`: 调用 wintun.dll。
    *   `tun_darwin.go`: 调用 macOS 原生 utun 接口。
    *   `tun_linux.go`: 调用 /dev/net/tun。

---
*Generated by Antigravity*
