# WireGuard åè®®æ ¸å¿ƒæ·±ç©¶ï¼šå¯†é’¥äº¤æ¢ä¸ Noise_IK

æœ¬æ–‡æ¡£è¯¦ç»†è®°å½•äº† WireGuard å¦‚ä½•é€šè¿‡ Noise_IK åè®®å®ç°æè‡´çš„å®‰å…¨æ¡æ‰‹ã€‚é‡ç‚¹é˜è¿°äº†æ¡æ‰‹è¿‡ç¨‹ä¸­çš„**å‰ç½®æ¡ä»¶**ä»¥åŠæ ¸å¿ƒçš„**4æ¬¡ ECDH è®¡ç®—**ã€‚

## æ ¸å¿ƒè®¾è®¡å“²å­¦
WireGuard çš„å®‰å…¨æ€§å»ºç«‹åœ¨ **"ç†Ÿäººç½‘ç»œ"** çš„åŸºç¡€ä¸Šã€‚å®ƒä¸åƒ HTTPS é‚£æ ·ä¾èµ– CA è¯ä¹¦æ¥ä¿¡ä»»é™Œç”Ÿäººï¼Œè€Œæ˜¯ä¾èµ–**é¢„å…ˆé…ç½®çš„é™æ€å…¬é’¥**ã€‚

æ¡æ‰‹åè®® (Handshake) çš„ç»ˆæç›®æ ‡æ˜¯ï¼šåœ¨ä¸å®‰å…¨çš„ç½‘ç»œä¸Šï¼ŒåŸºäºå·²çŸ¥çš„é™æ€èº«ä»½ï¼Œåå•†å‡ºä¸€å¯¹**ä¸´æ—¶çš„ã€å‰å‘ä¿å¯†çš„ (PFS)** å¯¹ç§°å¯†é’¥ (`SendKey` / `RecvKey`)ã€‚

---

## é˜¶æ®µ 0ï¼šå‰ç½®ä¿¡ä»»å»ºç«‹ (Prerequisite)
> **"æ²¡æœ‰è¿™ä¸€æ­¥ï¼Œåé¢çš„ä¸€åˆ‡éƒ½ä¸ä¼šå‘ç”Ÿã€‚"**

è¿™æ˜¯ç»å¸¸è¢«å¿½ç•¥ä½†è‡³å…³é‡è¦çš„ä¸€æ­¥ã€‚
1.  **å…¬é’¥äº’æ¢**ï¼šAlice å¿…é¡»é¢„å…ˆå°†è¢«å‘ŠçŸ¥ Bob çš„é™æ€å…¬é’¥ (`Static_Bob`)ï¼›Bob ä¹Ÿå¿…é¡»é¢„å…ˆè¢«å‘ŠçŸ¥ Alice çš„é™æ€å…¬é’¥ (`Static_Alice`)ã€‚
2.  **é…ç½®ç”Ÿæ•ˆ**ï¼šåŒæ–¹å°†å¯¹æ–¹çš„å…¬é’¥å†™å…¥é…ç½®æ–‡ä»¶æˆ–å†…å­˜ (`Known Peers`)ã€‚

å¦‚æœä¸€æ–¹ä¸è®¤è¯†å¦ä¸€æ–¹çš„å…¬é’¥ï¼Œæ¡æ‰‹è¯·æ±‚ä¼šè¢«**ç›´æ¥ä¸¢å¼ƒ (Silent Drop)**ï¼Œä¸ä¼šæœ‰ä»»ä½•é”™è¯¯å›æ‰§ã€‚è¿™ä¹Ÿæ˜¯ WireGuard æŠ—æ‰«æã€éšèº«ç‰¹æ€§çš„æ¥æºã€‚

---

## é˜¶æ®µ 1-3ï¼šæ¡æ‰‹å…¨æµç¨‹ (The Handshake)

WireGuard ä»…éœ€ **1-RTT (ä¸€æ¬¡å¾€è¿”)** å³å¯å®Œæˆæ¡æ‰‹ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒåŒæ–¹åœ¨åå°é»˜é»˜å®Œæˆäº† **4æ¬¡ æ ¸å¿ƒ ECDH è®¡ç®—**ï¼Œå°†èº«ä»½ä¸æ—¶é—´ç´§å¯†äº¤ç»‡ã€‚

### æ­¥éª¤ 1ï¼šAlice å‘èµ· (Initiator)
Alice ç”Ÿæˆä¸´æ—¶ç§é’¥ `e` (Ephemeral) åŠå…¶å¯¹åº”çš„ **ä¸´æ—¶å…¬é’¥ `E_pub`**ï¼Œå¼€å§‹è®¡ç®—ï¼š

| è®¡ç®—åºå· | åŸæ–™A (è‡ªå·±Â·ç§) x åŸæ–™B (å¯¹æ–¹Â·å…¬) | è®¡ç®—å…¬å¼ (DH) | ç›®çš„ |
| :--- | :--- | :--- | :--- |
| **DH #1** | `Aliceä¸´æ—¶ç§é’¥` x `Bobé™æ€å…¬é’¥` | `es = DH(e_priv, S_bob_pub)` | **é—®è·¯**ï¼šåŠ å¯†é™æ€å…¬é’¥ï¼Œåˆæ­¥éšè—èº«ä»½ã€‚ |
| **DH #2** | `Aliceé™æ€ç§é’¥` x `Bobé™æ€å…¬é’¥` | `ss = DH(S_alice_priv, S_bob_pub)` | **è®¤è¯ (Auth)**ï¼šè¯æ˜"æˆ‘æŒæœ‰Aliceç§é’¥"ã€‚åªæœ‰çœŸæ­£çš„ Alice èƒ½ç®—å¯¹ã€‚ |

*Alice å‘é€ï¼š`msg = { E_pub, Encrypted(Static, AuthTag) }`*

### æ­¥éª¤ 2ï¼šBob å“åº” (Responder)
Bob æ”¶åˆ°åŒ…ï¼ŒéªŒè¯é€šè¿‡åï¼Œç”Ÿæˆä¸´æ—¶ç§é’¥ `e'` åŠå…¶å¯¹åº”çš„ **ä¸´æ—¶å…¬é’¥ `E'_pub`**ï¼Œç»§ç»­è®¡ç®—ï¼š

| è®¡ç®—åºå· | åŸæ–™A (è‡ªå·±Â·ç§) x åŸæ–™B (å¯¹æ–¹Â·å…¬) | è®¡ç®—å…¬å¼ (DH) | ç›®çš„ |
| :--- | :--- | :--- | :--- |
| **DH #3** | `Bobä¸´æ—¶ç§é’¥` x `Aliceä¸´æ—¶å…¬é’¥` | `ee = DH(e'_priv, E_alice_pub)` | **å‰å‘ä¿å¯† (PFS)**ï¼šä¸¤ä¸ªä¸´æ—¶é’¥åŒ™ç¢°æ’ï¼Œç”Ÿæˆä»…å­˜äºå½“ä¸‹çš„ç§˜å¯†ã€‚ç”¨å®Œå³ç„šã€‚ |
| **DH #4** | `Bobé™æ€ç§é’¥` x `Aliceä¸´æ—¶å…¬é’¥` | `se = DH(S_bob_priv, E_alice_pub)` | **ç»‘å®š**ï¼šç¡®è®¤åˆšæ‰çš„ä¸´æ—¶å·¥ç¡®å®æ˜¯ Alice æ´¾æ¥çš„ã€‚ |

*Bob å‘é€ï¼š`msg = { E'_pub, Encrypted(Empty, AuthTag) }`*

### æ­¥éª¤ 3ï¼šå¯†é’¥è¾¾æˆ (Key Derivation)
å½“ Bob å‘å‡ºå“åº”ï¼Œä¸” Alice æ”¶åˆ°å“åº”åï¼ŒåŒæ–¹æ‰‹é‡Œéƒ½æ‹¥æœ‰äº†å®Œå…¨ä¸€è‡´çš„ 4 ä¸ª DH ç»“æœé“¾ã€‚
é€šè¿‡ HKDF ç®—æ³•ï¼Œå°†è¿™æ ¹é“¾æ¡åˆ†è£‚ (Split)ï¼š
*   **SendKey**
*   **RecvKey**

æ­¤åï¼Œæ‰€æœ‰æ•°æ®åŒ…ä½¿ç”¨è¿™ä¸¤ä¸ªå¯†é’¥è¿›è¡Œ ChaCha20Poly1305 åŠ å¯†ã€‚

---

## ä¸ºä»€ä¹ˆè¦ç®— 4 æ¬¡ï¼Ÿ (The "Why")

è¿™ 4 æ¬¡è®¡ç®—ç¼ºä¸€ä¸å¯ï¼Œæ„æˆäº†å®‰å…¨æ€§çš„**"ä¸‰ä½ä¸€ä½“"**ï¼š

1.  **èº«ä»½è®¤è¯ (Authentication)**
    *   é  `ss` (Static-Static) å’Œ `se` ä¿è¯ã€‚
    *   é˜²æ­¢ä¸­é—´äººæ”»å‡» (MITM)ã€‚
2.  **å‰å‘ä¿å¯† (PFS - Perfect Forward Secrecy)**
    *   é  `ee` (Ephemeral-Ephemeral) ä¿è¯ã€‚
    *   å³ä½¿æœªæ¥é•¿æœŸç§é’¥æ³„éœ²ï¼Œå†å²æµé‡ä¹Ÿæ— æ³•è§£å¯†ã€‚
3.  **é˜²é‡æ”¾ (Anti-Replay)**
    *   é  `ee` å’Œ Hash ä¸­çš„ Counter ä¿è¯ã€‚
    *   é˜²æ­¢æ”»å‡»è€…å½•åˆ¶æ—§çš„æ¡æ‰‹åŒ…æ¥æ¬ºéª—æœåŠ¡å™¨ã€‚

---

## æµç¨‹å›¾ (Sequence Diagram)

```mermaid
sequenceDiagram
    participant Alice as Alice (å‘èµ·è€…)
    participant Bob as Bob (å“åº”è€…)
    
    Note over Alice, Bob: ğŸš« Phase 0: å¿…é¡»é¢„å…ˆäº’çŸ¥é™æ€å…¬é’¥ (S) ğŸš«
    
    %% --- Alice Generation ---
    rect rgb(230, 240, 255)
    Note over Alice: == [Step 1: Alice è®¡ç®—] ==
    Note over Alice: 1. ç”Ÿæˆä¸´æ—¶ç§é’¥ e
    Note over Alice: 2. es = DH(e, S_bob)
    Note over Alice: 3. ss = DH(S_alice, S_bob) (è®¤è¯æ ¸å¿ƒ)
    Note over Alice: æ··åˆ Hashï¼Œæ‰“åŒ…
    end

    Alice->>Bob: æ¡æ‰‹è¯·æ±‚ (Initiation)

    %% --- Bob Processing ---
    rect rgb(255, 250, 230)
    Note over Bob: == [Step 2: Bob éªŒè¯ä¸å“åº”] ==
    Note over Bob: (éªŒè¯ ssï¼Œç¡®è®¤æ˜¯ Alice)
    Note over Bob: 1. ç”Ÿæˆä¸´æ—¶ç§é’¥ e'
    Note over Bob: 2. ee = DH(e', E_alice) (PFSæ ¸å¿ƒ)
    Note over Bob: 3. se = DH(e', S_alice)
    Note over Bob: [Step 3: æ´¾ç”Ÿä¼šè¯å¯†é’¥]
    Note over Bob: SendKey / RecvKey
    end

    Bob->>Alice: æ¡æ‰‹å“åº” (Response)
    
    %% --- Alice Processing ---
    rect rgb(230, 240, 255)
    Note over Alice: == [Step 4: Alice æ¥æ”¶] ==
    Note over Alice: (è®¡ç®— ee, se)
    Note over Alice: [Step 3: æ´¾ç”Ÿä¼šè¯å¯†é’¥]
    Note over Alice: SendKey / RecvKey
    end
    
    Note over Alice, Bob: ğŸ”µ æ¡æ‰‹ç»“æŸ: é€šé“å»ºç«‹ ğŸ”µ
```
